<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ESL Racing - Stable Edition</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg: #090a0f; --primary: #00ffcc; --secondary: #7000ff; 
            --danger: #ff0055; --success: #00ff66; --text: #ffffff;
            --panel: rgba(15, 20, 30, 0.85);
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; touch-action: manipulation; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .screen { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at center, #1a1c29 0%, #090a0f 100%); z-index: 10; padding: 20px;}
        .active-screen { display: flex; }
        
        .glass-card { background: var(--panel); backdrop-filter: blur(15px); padding: 40px 30px; border-radius: 15px; text-align: center; border: 2px solid rgba(0, 255, 204, 0.3); width: 100%; max-width: 450px; box-shadow: 0 0 30px rgba(0, 255, 204, 0.15); }
        h1 { margin-top: 0; color: var(--primary); font-size: 36px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px var(--primary); font-style: italic;}
        
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.5); color: white; font-size: 16px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0,255,204,0.3); }
        
        .btn { width: 100%; padding: 15px; border-radius: 8px; border: none; font-size: 18px; font-weight: 900; cursor: pointer; margin-top: 15px; color: #000; background: var(--primary); text-transform: uppercase; transition: 0.2s; box-shadow: 0 5px 15px rgba(0, 255, 204, 0.4); }
        .btn:active { transform: scale(0.95); }

        #players-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 25px; max-height: 200px; overflow-y: auto; }
        .player-badge { background: rgba(255,255,255,0.05); padding: 8px 15px; border-radius: 20px; border: 1px solid; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 5px; }

        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; display: none; flex-direction: column; pointer-events: none; }
        #top-bar { padding: 10px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.85); border-bottom: 2px solid var(--primary); pointer-events: auto; }
        .stat-box { text-align: center; font-weight: bold; font-size: 11px; flex: 1; padding: 0 5px; color: #aaa;}
        .stat-val { font-size: 16px; color: var(--primary); text-shadow: 0 0 5px var(--primary); }
        #fuel-container { width: 100%; height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; margin-top: 5px; overflow: hidden; }
        #fuel-bar { width: 100%; height: 100%; background: var(--success); transition: width 0.3s; box-shadow: 0 0 10px var(--success);}
        
        canvas { display: block; width: 100%; height: 100%; background: #228b22; } 

        #controls { position: absolute; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: space-between; gap: 10px; padding: 0 15px; pointer-events: auto; z-index: 2; }
        .steer-group { display: flex; gap: 10px; }
        .steer-btn { flex: 1; padding: 20px 0; font-size: 28px; text-align: center; border-radius: 12px; background: rgba(0,0,0,0.7); color: white; border: 2px solid rgba(255,255,255,0.2); cursor: pointer; backdrop-filter: blur(5px); }
        .steer-btn:active { background: rgba(255, 255, 255, 0.2); border-color: white; }
        .gas-btn { background: rgba(0, 255, 102, 0.2); border-color: var(--success); color: var(--success); font-weight: 900; font-size: 22px; text-shadow: 0 0 5px var(--success); }
        .gas-btn:active { background: var(--success); color: black; text-shadow: none; transform: scale(0.95); }

        .modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; padding: 20px; pointer-events: auto; flex-direction: column;}
        .answer-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--primary); margin: 5px 0; padding: 15px; border-radius: 8px; color: white; width: 100%; font-size: 16px; cursor: pointer; transition: 0.2s; text-align: left; padding-left: 20px;}
        .answer-btn:active { background: var(--primary); color: black; }
        
        .door-container { display: flex; justify-content: space-around; width: 100%; margin-top: 20px; gap: 10px;}
        .door { flex: 1; aspect-ratio: 1/1.5; background: #3e2723; border: 3px solid #795548; display: flex; align-items: center; justify-content: center; font-size: 40px; cursor: pointer; border-radius: 8px; transition: transform 0.2s, order 0.3s; box-shadow: inset 0 0 20px black;}
        
        #toast { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: var(--primary); color: black; padding: 12px 25px; border-radius: 30px; font-weight: 900; font-size: 16px; display: none; z-index: 200; text-align: center; width: auto; white-space: nowrap; box-shadow: 0 5px 20px rgba(0,0,0,0.6); text-transform: uppercase;}
        
        @keyframes boost-glow { 0% { box-shadow: 0 0 10px #00d2ff; background: rgba(0, 210, 255, 0.3); color: white;} 50% { box-shadow: 0 0 30px #00d2ff; background: #00d2ff; color: black; border-color: white;} 100% { box-shadow: 0 0 10px #00d2ff; background: rgba(0, 210, 255, 0.3); color: white;} }
        .boosting-ui { animation: boost-glow 0.4s infinite !important; border-color: #00d2ff !important; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; text-shadow: 0 0 10px var(--primary); } 100% { opacity: 0.5; } }
        .waiting-text { color: var(--primary); margin-top: 20px; font-size: 18px; font-weight: bold; letter-spacing: 1px; animation: pulse 1.5s infinite; text-transform: uppercase; }

        .rank-row { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; background: rgba(255,255,255,0.05); border-left: 5px solid; }
    </style>
</head>
<body>

    <div id="screen-lobby" class="screen active-screen">
        <div class="glass-card">
            <h1>ESL Racing</h1>
            <p style="color: #888; margin-top: -10px; margin-bottom: 25px;">by Sebas</p>
            <input type="text" id="room-input" placeholder="Room Code (e.g. 505)">
            <input type="text" id="name-input" placeholder="Your Name">
            <button class="btn" onclick="joinRoom()">JOIN LOBBY</button>
        </div>
    </div>

    <div id="screen-waiting" class="screen">
        <div class="glass-card">
            <h2 style="margin-top: 0; color: #aaa;">ROOM CODE</h2>
            <h1 id="room-code-display" style="font-size: 45px; margin: 5px 0 20px 0;"></h1>
            <div id="players-list"></div>
            <div class="waiting-text">Waiting for Host to start...</div>
        </div>
    </div>

    <canvas id="game-canvas"></canvas>
    
    <div id="game-ui">
        <div id="top-bar">
            <div class="stat-box">TIME<br><span class="stat-val" id="time-val">10:00</span></div>
            <div class="stat-box">SPEED<br><span class="stat-val" id="speed-val">0 km/h</span></div>
            <div class="stat-box" style="flex: 2;">FUEL<div id="fuel-container"><div id="fuel-bar"></div></div></div>
            <div class="stat-box">TRACK<br><span class="stat-val" id="prog-val">0%</span></div>
        </div>
        
        <div id="controls">
            <div class="steer-group" style="width: 45%;">
                <div class="steer-btn" onmousedown="steer(-1)" onmouseup="stopSteer()" ontouchstart="steer(-1)" ontouchend="stopSteer()">‚óÄ</div>
                <div class="steer-btn" onmousedown="steer(1)" onmouseup="stopSteer()" ontouchstart="steer(1)" ontouchend="stopSteer()">‚ñ∂</div>
            </div>
            <div class="steer-group" style="width: 52%;">
                <div class="steer-btn" onmousedown="reverse(true)" onmouseup="reverse(false)" ontouchstart="reverse(true)" ontouchend="reverse(false)" style="background: rgba(255, 0, 85, 0.2); border-color: var(--danger); color: var(--danger); font-size: 20px; width: 30%;">‚è¨</div>
                <div id="gas-btn" class="steer-btn gas-btn" onmousedown="gas(true)" onmouseup="gas(false)" ontouchstart="gas(true)" ontouchend="gas(false)" style="width: 70%;">‚õΩ GO</div>
            </div>
        </div>
    </div>

    <div id="modal-question" class="modal">
        <div class="glass-card" style="border-color: var(--danger);">
            <h2 style="color: var(--danger); font-size: 30px; margin-top:0;">OUT OF FUEL!</h2>
            <h3 id="question-text" style="margin: 20px 0; color: white;"></h3>
            <div id="answers-container"></div>
        </div>
    </div>

    <div id="modal-doors" class="modal">
        <div class="glass-card" style="border-color: var(--secondary); max-width: 500px;">
            <h2 style="color: var(--secondary); margin-top:0;">SABOTAGE TIME!</h2>
            <p style="color: #ccc;">Find the keys to steal fuel or teleport to 1st place!</p>
            <div class="door-container" id="doors-wrapper">
                <div class="door" onclick="selectDoor(0)">üö™</div>
                <div class="door" onclick="selectDoor(1)">üö™</div>
                <div class="door" onclick="selectDoor(2)">üö™</div>
                <div class="door" onclick="selectDoor(3)">üö™</div>
            </div>
        </div>
    </div>

    <div id="modal-victim" class="modal">
        <div class="glass-card" style="border-color: var(--success);">
            <h2 style="color: var(--success); margin-top:0;">CHOOSE A VICTIM</h2>
            <p style="color: #ccc;">Who do you want to steal fuel from?</p>
            <div id="victim-list"></div>
            <button class="answer-btn" style="border-color:var(--danger); margin-top:15px; text-align:center; color: var(--danger);" onclick="closeVictimModal()">CANCEL</button>
        </div>
    </div>

    <div id="modal-leaderboard" class="modal">
        <div class="glass-card" style="border-color: #ffd700; max-height: 80vh; overflow-y: auto;">
            <h2 style="color: #ffd700; font-size: 30px; margin-top:0;">üèÅ RACE RESULTS üèÅ</h2>
            <div id="leaderboard-content" style="margin-bottom: 20px;"></div>
            <button class="btn" style="background:#ffd700" onclick="location.reload()">MAIN MENU</button>
        </div>
    </div>

    <div id="toast">Message</div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBgrOIewoSwJ8lBUGyqph2mYtzTHGxq3aM",
            authDomain: "eslrace.firebaseapp.com",
            databaseURL: "https://eslrace-default-rtdb.firebaseio.com",
            projectId: "eslrace"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const questions = [
            { q: "The opposite of 'big' is:", options: ["Small", "Tall", "Fast"], a: 0 },
            { q: "A yellow fruit:", options: ["Apple", "Banana", "Grape"], a: 1 },
            { q: "The day before Friday is:", options: ["Saturday", "Wednesday", "Thursday"], a: 2 },
            { q: "You drink this in the morning:", options: ["Coffee", "Bread", "Cheese"], a: 0 },
            { q: "A domestic animal that barks:", options: ["Cat", "Dog", "Bird"], a: 1 },
            { q: "The plural of 'child' is:", options: ["Childs", "Childes", "Children"], a: 2 },
            { q: "The color of the sky is:", options: ["Blue", "Green", "Red"], a: 0 },
            { q: "12:00 is:", options: ["Zero o'clock", "Twelve o'clock", "Twelve past zero"], a: 1 },
            { q: "The opposite of 'hot' is:", options: ["Warm", "Cold", "Sun"], a: 1 },
            { q: "You wear this on your head:", options: ["Shoe", "Glove", "Hat"], a: 2 },
            { q: "He ___ a doctor.", options: ["am", "are", "is"], a: 2 },
            { q: "I ___ to school every day.", options: ["go", "goes", "going"], a: 0 },
            { q: "She ___ playing tennis right now.", options: ["am", "is", "are"], a: 1 },
            { q: "___ you like pizza?", options: ["Do", "Does", "Are"], a: 0 },
            { q: "They ___ not at home yesterday.", options: ["was", "were", "did"], a: 1 },
            { q: "I have ___ apple in my bag.", options: ["a", "an", "two"], a: 1 },
            { q: "This book is ___ than that one.", options: ["gooder", "better", "more good"], a: 1 },
            { q: "How ___ water do you drink?", options: ["many", "much", "any"], a: 1 },
            { q: "There ___ three cars in the street.", options: ["is", "are", "am"], a: 1 },
            { q: "I ___ born in 2005.", options: ["was", "were", "am"], a: 0 },
            { q: "The month after March is:", options: ["April", "May", "June"], a: 0 },
            { q: "A place to read or borrow books:", options: ["Bakery", "Library", "Pharmacy"], a: 1 },
            { q: "You use this to see in the dark:", options: ["Mirror", "Book", "Flashlight"], a: 2 },
            { q: "The opposite of 'fast' is:", options: ["Slow", "Quick", "Hard"], a: 0 },
            { q: "A green vegetable that looks like a tree:", options: ["Tomato", "Carrot", "Broccoli"], a: 2 },
            { q: "You drive a:", options: ["Car", "Bike", "Boat"], a: 0 },
            { q: "The number after 99 is:", options: ["98", "100", "101"], a: 1 },
            { q: "You cut meat with a:", options: ["Spoon", "Fork", "Knife"], a: 2 },
            { q: "People go to a ___ to watch movies.", options: ["Hospital", "Cinema", "Supermarket"], a: 1 },
            { q: "A sweet food made from cocoa:", options: ["Chocolate", "Cheese", "Salad"], a: 0 },
            { q: "My mother's sister is my:", options: ["Cousin", "Aunt", "Grandmother"], a: 1 },
            { q: "My father's brother is my:", options: ["Uncle", "Nephew", "Son"], a: 0 },
            { q: "You use a bed to:", options: ["Cook", "Work", "Sleep"], a: 2 },
            { q: "You use a pen to:", options: ["Write", "Read", "Listen"], a: 0 },
            { q: "The past tense of 'Go' is:", options: ["Goed", "Went", "Gone"], a: 1 },
            { q: "The past tense of 'Eat' is:", options: ["Eated", "Ate", "Eaten"], a: 1 },
            { q: "We use our ears to:", options: ["See", "Smell", "Hear"], a: 2 },
            { q: "A person who works in a hospital is a:", options: ["Teacher", "Farmer", "Nurse"], a: 2 },
            { q: "Spring, Summer, Autumn, and ___.", options: ["Winter", "Rain", "Snow"], a: 0 },
            { q: "You wash your hands with water and:", options: ["Juice", "Soap", "Milk"], a: 1 }
        ];

        const sceneryEmojis = ['üå≤', 'üå≥', 'üè¢', 'üêÑ', 'üêé', 'üè†', 'üå¥', 'üöú', 'üåµ', '‚õ∫', '‚õΩ'];

        let roomCode = "";
        let playerName = "";
        let playerId = "P_" + Math.random().toString(36).substr(2, 9);
        let myColor = `hsl(${Math.random() * 360}, 100%, 55%)`;
        
        let fuel = 0;
        let progress = 0; 
        let speed = 0;
        let maxSpeed = 280; 
        let gameActive = false;
        let hasFinished = false;
        let leaderboardShown = false;
        let otherPlayers = {};
        
        let isGasPressed = false;
        let isRevPressed = false;
        let carX = 0; 
        let steerDir = 0; 
        let globalEndTime = 0;
        
        let boostTimer = 0; 
        let sabotageTimer = 80; 
        let isModalOpen = false;
        let sabotageOutcomes = [];

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        function joinRoom() {
            roomCode = document.getElementById('room-input').value.trim().toUpperCase();
            playerName = document.getElementById('name-input').value.trim();
            if(!roomCode || !playerName) return;

            document.getElementById('screen-lobby').classList.remove('active-screen');
            document.getElementById('screen-waiting').classList.add('active-screen');
            document.getElementById('room-code-display').innerText = roomCode;

            db.ref(`rooms/${roomCode}/players/${playerId}`).set({ name: playerName, progress: 0, fuel: 0, color: myColor, x: 0 });
            db.ref(`rooms/${roomCode}/players/${playerId}`).onDisconnect().remove();

            db.ref(`rooms/${roomCode}/players/${playerId}/robbedBy`).on('value', snap => {
                if(snap.val()) {
                    let robber = snap.val();
                    fuel = Math.max(0, fuel - 15);
                    showToast(`üö® ${robber.toUpperCase()} STOLE 15 FUEL! üö®`, true);
                    db.ref(`rooms/${roomCode}/players/${playerId}/robbedBy`).remove();
                }
            });

            db.ref(`rooms/${roomCode}/players`).on('value', snap => {
                otherPlayers = snap.val() || {};
                
                // CRITICAL FIX: Only update DOM if we are NOT in the game
                // This prevents the phone from trying to rebuild HTML 40 times a second during the race
                if(!gameActive) {
                    let html = "";
                    for(let id in otherPlayers) {
                        html += `<div class="player-badge" style="border-color:${otherPlayers[id].color}; color:${otherPlayers[id].color}">üèéÔ∏è ${otherPlayers[id].name}</div>`;
                    }
                    document.getElementById('players-list').innerHTML = html;
                }
            });

            db.ref(`rooms/${roomCode}/state`).on('value', snap => {
                if(snap.val() && snap.val().playing && !gameActive) {
                    globalEndTime = snap.val().endTime;
                    initGame();
                }
            });
        }

        function initGame() {
            gameActive = true;
            document.getElementById('screen-waiting').classList.remove('active-screen');
            document.getElementById('game-ui').style.display = 'flex';
            
            let allIds = Object.keys(otherPlayers);
            if(!allIds.includes(playerId)) allIds.push(playerId);
            allIds.sort();
            let myIndex = allIds.indexOf(playerId);
            let totalPlayers = allIds.length;
            
            if(totalPlayers <= 1) {
                carX = 0;
            } else {
                let maxSpread = 1.5; 
                let step = maxSpread / (totalPlayers - 1);
                carX = -0.75 + (myIndex * step);
            }

            checkFuel();
            gameLoop();
            setInterval(updateTimers, 1000);
            
            // OPTIMIZED: Increased sync time to 200ms to reduce network congestion
            setInterval(() => {
                if(gameActive) {
                    db.ref(`rooms/${roomCode}/players/${playerId}`).update({ progress: progress, fuel: fuel, x: carX });
                }
            }, 200);
        }

        function steer(dir) { steerDir = dir; }
        function stopSteer() { steerDir = 0; }
        function gas(state) { isGasPressed = state; }
        function reverse(state) { isRevPressed = state; }

        function updateTimers() {
            if(!gameActive) return;
            let timeLeft = Math.floor((globalEndTime - Date.now()) / 1000);
            
            if(timeLeft <= 0) {
                document.getElementById('time-val').innerText = "00:00";
                if(!leaderboardShown) showLeaderboard();
                return;
            }
            
            document.getElementById('time-val').innerText = `${Math.floor(timeLeft/60)}:${timeLeft%60<10?'0':''}${timeLeft%60}`;

            if(hasFinished) return;

            if(fuel > 0 && Math.abs(speed) > 10) fuel--;
            
            if(fuel <= 0 && Math.abs(speed) < 5 && !isModalOpen) {
                isGasPressed = false; isRevPressed = false; checkFuel();
            }

            if(speed > 0 && fuel > 0 && !isModalOpen) {
                sabotageTimer--;
                if(sabotageTimer <= 0) {
                    sabotageTimer = 80;
                    triggerSabotage();
                }
            }

            let fPercent = (fuel / 40) * 100;
            document.getElementById('fuel-bar').style.width = Math.min(fPercent, 100) + "%";
            document.getElementById('prog-val').innerText = Math.floor(progress) + "%";
        }

        function showLeaderboard() {
            leaderboardShown = true;
            gameActive = false;
            let playersArray = [];
            for(let id in otherPlayers) {
                playersArray.push({name: otherPlayers[id].name, prog: otherPlayers[id].progress, color: otherPlayers[id].color, isMe: id === playerId});
            }
            playersArray.sort((a,b) => b.prog - a.prog);
            
            let html = "";
            playersArray.forEach((p, i) => {
                let rank = i === 0 ? "ü•á" : i === 1 ? "ü•à" : i === 2 ? "ü•â" : `${i+1}th`;
                let nameLabel = p.isMe ? `${p.name} (YOU)` : p.name;
                html += `<div class="rank-row" style="border-color: ${p.color}">
                            <span style="font-weight:bold; font-size:18px;">${rank} ${nameLabel}</span>
                            <span style="color:var(--primary); font-weight:bold;">${Math.floor(p.prog)}%</span>
                         </div>`;
            });
            document.getElementById('leaderboard-content').innerHTML = html;
            document.getElementById('modal-leaderboard').style.display = 'flex';
        }

        function checkFuel() {
            isModalOpen = true;
            let q = questions[Math.floor(Math.random() * questions.length)];
            document.getElementById('question-text').innerText = q.q;
            let html = "";
            q.options.forEach((opt, i) => html += `<button class="answer-btn" onclick="answer(${i}, ${q.a})"><span style="color:var(--primary); font-weight:bold;">${String.fromCharCode(65+i)}.</span> ${opt}</button>`);
            document.getElementById('answers-container').innerHTML = html;
            document.getElementById('modal-question').style.display = 'flex';
        }

        window.answer = function(sel, cor) {
            if(sel === cor) {
                fuel = 40; db.ref(`rooms/${roomCode}/players/${playerId}`).update({ fuel: fuel });
                document.getElementById('modal-question').style.display = 'none';
                isModalOpen = false;
            } else checkFuel();
        }

        function triggerSabotage() {
            isModalOpen = true; isGasPressed = false; isRevPressed = false;
            document.getElementById('modal-doors').style.display = 'flex';
            
            sabotageOutcomes = ["steal", "steal", "teleport", "empty"];
            sabotageOutcomes.sort(() => Math.random() - 0.5);

            let doors = document.querySelectorAll('.door');
            doors.forEach(d => { d.innerText = 'üö™'; d.style.pointerEvents = 'none'; d.style.background = '#3e2723'; });
            
            let shuffles = 0;
            let interval = setInterval(() => {
                doors.forEach(d => d.style.order = Math.floor(Math.random() * 5));
                shuffles++;
                if(shuffles > 8) { 
                    clearInterval(interval);
                    doors.forEach(d => { d.innerText = '‚ùì'; d.style.pointerEvents = 'auto'; });
                    showToast("PICK A DOOR!", false);
                }
            }, 200);
        }

        window.selectDoor = function(index) {
            document.getElementById('modal-doors').style.display = 'none';
            let outcome = sabotageOutcomes[index];
            
            if(outcome === "steal") {
                showVictims();
            } else if (outcome === "teleport") {
                let maxProg = progress;
                for(let id in otherPlayers) {
                    if(otherPlayers[id].progress > maxProg) maxProg = otherPlayers[id].progress;
                }
                progress = Math.min(100, maxProg + 1); 
                showToast("üöÄ TELEPORTED TO 1ST PLACE!", false);
                isModalOpen = false;
            } else {
                showToast("Empty room! No keys.", true);
                isModalOpen = false;
            }
        }

        function showVictims() {
            let html = ""; let found = false;
            for(let id in otherPlayers) {
                if(id !== playerId) {
                    html += `<button class="answer-btn" style="border-left: 5px solid ${otherPlayers[id].color}" onclick="robPlayer('${id}')">Steal from ${otherPlayers[id].name}</button>`;
                    found = true;
                }
            }
            if(!found) html = "<p style='color:white'>No other players to rob!</p>";
            document.getElementById('victim-list').innerHTML = html;
            document.getElementById('modal-victim').style.display = 'flex';
        }

        window.robPlayer = function(targetId) {
            db.ref(`rooms/${roomCode}/players/${targetId}`).update({ robbedBy: playerName });
            fuel = Math.min(40, fuel + 15); 
            db.ref(`rooms/${roomCode}/players/${playerId}`).update({ fuel: fuel });
            document.getElementById('modal-victim').style.display = 'none';
            showToast("‚õΩ STOLE 15 FUEL!", false);
            isModalOpen = false;
        }

        window.closeVictimModal = function() {
            document.getElementById('modal-victim').style.display = 'none';
            isModalOpen = false;
        }

        function getCurve(y) { return Math.sin(y * 0.002) * Math.cos(y * 0.0005) * (canvas.width * 0.4); }
        function getRoadAngle(absY) { return Math.atan2(getCurve(absY + 20) - getCurve(absY), 20); }

        function drawCar(ctx, x, y, color, label, angle = 0, isBoosting = false) {
            ctx.save(); ctx.translate(x, y); ctx.rotate(angle);
            if(isBoosting) { ctx.shadowBlur = 15; ctx.shadowColor = "#00ffcc"; }
            ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(-15, -25, 30, 50); ctx.shadowBlur = 0; 
            ctx.fillStyle = "#050505";
            ctx.fillRect(-20, -18, 6, 12); ctx.fillRect(14, -18, 6, 12);
            ctx.fillRect(-20, 18, 6, 12); ctx.fillRect(14, 18, 6, 12);
            ctx.fillStyle = color; ctx.beginPath(); ctx.roundRect(-16, -28, 32, 56, 5); ctx.fill();
            ctx.fillStyle = "#1a1c29"; 
            ctx.beginPath(); ctx.roundRect(-12, -12, 24, 15, 3); ctx.fill();
            ctx.beginPath(); ctx.roundRect(-10, 18, 20, 8, 2); ctx.fill();
            ctx.rotate(-angle);
            ctx.fillStyle = "white"; ctx.font = "bold 13px Arial"; ctx.textAlign = "center";
            ctx.fillText(label, 0, -42);
            ctx.restore();
        }

        function drawMinimap() {
            let mWidth = 6; let mHeight = canvas.height * 0.5;
            let mX = canvas.width - 20; let mY = (canvas.height - mHeight) / 2;
            ctx.fillStyle = "rgba(0,0,0,0.6)"; ctx.fillRect(mX, mY, mWidth, mHeight);
            ctx.fillStyle = "var(--primary)"; ctx.fillRect(mX-2, mY, mWidth+4, 2); 
            
            for(let id in otherPlayers) {
                let p = otherPlayers[id];
                let py = mY + mHeight - (Math.min(p.progress, 100) / 100 * mHeight);
                ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(mX + mWidth/2, py, id === playerId ? 5 : 4, 0, Math.PI*2); ctx.fill();
                if(id === playerId) { ctx.strokeStyle="white"; ctx.lineWidth=1; ctx.stroke(); }
            }
        }

        function showToast(msg, isUrgent = false) {
            let t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            t.style.background = isUrgent ? "var(--danger)" : "var(--primary)";
            t.style.color = isUrgent ? "white" : "black";
            setTimeout(() => t.style.display = 'none', 2500);
        }

        function gameLoop() {
            if(!gameActive) return requestAnimationFrame(gameLoop);

            let speedMultiplier = 1;
            if(boostTimer > 0) {
                boostTimer--; speedMultiplier = 3;
                document.getElementById('gas-btn').classList.add('boosting-ui');
            } else { document.getElementById('gas-btn').classList.remove('boosting-ui'); }

            if(isGasPressed && fuel > 0 && !isModalOpen && !hasFinished) {
                speed += 4.0; if(speed > maxSpeed) speed = maxSpeed;
            } else if (isRevPressed && !isModalOpen && !hasFinished) {
                speed -= 3.0; if(speed < -40) speed = -40;
            } else {
                if(speed > 0) { speed -= 2; if(speed < 0) speed = 0; }
                if(speed < 0) { speed += 2; if(speed > 0) speed = 0; }
            }

            if(speed > 80 && !isModalOpen && !hasFinished) {
                carX += (Math.sin(Date.now() / 300) * 0.003) + (Math.random() - 0.5) * 0.005; 
            }

            let displaySpeed = Math.floor(speed * (speed > 0 ? speedMultiplier : 1));
            document.getElementById('speed-val').innerText = displaySpeed + " km/h";

            if(Math.abs(speed) > 0 && !hasFinished) {
                progress += (displaySpeed) * 0.000008; 
                carX += steerDir * (Math.abs(speed) / maxSpeed) * 0.05; 
            }
            if(carX < -1) { carX = -1; speed *= 0.95; } 
            if(carX > 1) { carX = 1; speed *= 0.95; }
            if(progress < 0) progress = 0;

            let finishLineAbsY = 400000; 
            
            if(progress >= 100 && !hasFinished) {
                progress = 100; hasFinished = true; speed = 0; isGasPressed = false; isRevPressed = false;
                showToast("üèÅ FINISHED THE RACE! üèÅ");
                document.getElementById('prog-val').innerText = "100%";
                setTimeout(showLeaderboard, 3000); 
            }

            for(let id in otherPlayers) {
                if(id !== playerId) {
                    let op = otherPlayers[id];
                    if(Math.abs(progress - op.progress) < 0.2 && Math.abs(carX - op.x) < 0.12) {
                        carX += (carX > op.x) ? 0.05 : -0.05; 
                        speed *= 0.6; 
                        showToast("üí• CRASH!");
                    }
                }
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let roadWidth = canvas.width * 0.75;
            let moveRange = (roadWidth / 2) - 20;
            
            let myTrackAbsoluteY = (progress * 2500); 
            let myCarAbsY = myTrackAbsoluteY + 300; 

            for(let y = 0; y < canvas.height; y += 5) {
                let trackAbsoluteY = myTrackAbsoluteY + (canvas.height - y);
                if(trackAbsoluteY > finishLineAbsY + 50) continue; 
                let curveOffset = getCurve(trackAbsoluteY);
                let centerX = (canvas.width / 2) + curveOffset;
                ctx.fillStyle = "#2c3e50"; ctx.fillRect(centerX - roadWidth/2, y, roadWidth, 6);
                let rumbleColor = (trackAbsoluteY % 80 < 40) ? "#e74c3c" : "#ecf0f1";
                ctx.fillStyle = rumbleColor;
                ctx.fillRect(centerX - roadWidth/2 - 12, y, 12, 6);
                ctx.fillRect(centerX + roadWidth/2, y, 12, 6);
                if(trackAbsoluteY % 120 < 60) { ctx.fillStyle = "rgba(255,255,255,0.6)"; ctx.fillRect(centerX - 3, y, 6, 8); }
            }

            let startLineAbsY = 100; 
            let startScreenY = canvas.height - (startLineAbsY - myTrackAbsoluteY);
            if(startScreenY > -50 && startScreenY < canvas.height + 50) {
                let sCenterX = (canvas.width / 2) + getCurve(startLineAbsY);
                for(let i = 0; i < roadWidth; i+=20) {
                    ctx.fillStyle = (i/20)%2===0 ? "white" : "black";
                    ctx.fillRect((sCenterX - roadWidth/2) + i, startScreenY, 20, 20);
                }
            }

            let itemStart = Math.floor(myTrackAbsoluteY / 100) * 100;
            let itemEnd = itemStart + canvas.height + 200; 

            for(let y = itemStart; y <= itemEnd; y += 100) {
                if(y % 900 === 0 && y > 400 && y < finishLineAbsY) {
                    let safeLaneIndex = Math.floor(Math.abs(Math.sin(y * 123)) * 3); 
                    let lanes = [-0.65, 0, 0.65];
                    let safeLane = lanes[safeLaneIndex];

                    let screenY = canvas.height - (y - myTrackAbsoluteY);
                    if(screenY > -50 && screenY < canvas.height + 50) {
                        let curve = getCurve(y);
                        let centerX = canvas.width / 2 + curve;
                        
                        lanes.forEach(lane => {
                            if(lane !== safeLane) {
                                let logX = centerX + (lane * moveRange);
                                ctx.fillStyle = "#5C3A21"; ctx.fillRect(logX - 35, screenY - 10, 70, 20); 
                                ctx.fillStyle = "#3e2723"; ctx.fillRect(logX - 30, screenY - 5, 60, 10); 
                                
                                if(Math.abs(y - myCarAbsY) < 20 && Math.abs(carX - lane) < 0.22 && speed > 10) {
                                    speed = 5; 
                                    progress -= 0.1; 
                                    showToast("üí• HIT A LOG!", true);
                                }
                            }
                        });
                    }
                }

                if(y % 1500 === 0 && y > 400 && y < finishLineAbsY) {
                    let laneIndex = Math.floor(Math.abs(Math.cos(y * 321)) * 3);
                    let lanes = [-0.65, 0, 0.65];
                    let boostLane = lanes[laneIndex];

                    let screenY = canvas.height - (y - myTrackAbsoluteY);
                    if(screenY > -50 && screenY < canvas.height + 50) {
                        let padX = canvas.width / 2 + getCurve(y) + (boostLane * moveRange);
                        ctx.fillStyle = "rgba(0, 255, 204, 0.8)"; ctx.shadowBlur = 15; ctx.shadowColor = "#00ffcc";
                        ctx.fillRect(padX - 25, screenY - 25, 50, 50); 
                        ctx.fillStyle = "black"; ctx.font = "25px Arial"; ctx.textAlign = "center";
                        ctx.fillText("‚ö°", padX, screenY + 8); ctx.shadowBlur = 0;
                        
                        if(Math.abs(y - myCarAbsY) < 25 && Math.abs(carX - boostLane) < 0.25 && boostTimer <= 0) {
                            boostTimer = 600; 
                            showToast("‚ö° SPEED SURGE!", false);
                        }
                    }
                }
            }

            let finishScreenY = canvas.height - (finishLineAbsY - myTrackAbsoluteY);
            if(finishScreenY > -50 && finishScreenY < canvas.height + 50) {
                let fCenterX = (canvas.width / 2) + getCurve(finishLineAbsY);
                for(let i = 0; i < roadWidth; i+=20) {
                    ctx.fillStyle = (i/20)%2===0 ? "white" : "black";
                    ctx.fillRect((fCenterX - roadWidth/2) + i, finishScreenY, 20, 20);
                }
            }

            for(let objY = itemStart; objY <= itemEnd; objY += 80) {
                let randLeft = Math.abs(Math.sin(objY * 12.345));
                let randRight = Math.abs(Math.cos(objY * 12.345));
                let screenY = canvas.height - (objY - myTrackAbsoluteY);
                let centerX = (canvas.width / 2) + getCurve(objY);

                ctx.font = "35px Arial"; ctx.textAlign = "center";
                if(randLeft > 0.15) ctx.fillText(sceneryEmojis[Math.floor((randLeft * 100) % sceneryEmojis.length)], centerX - roadWidth/2 - 40 - (randLeft*50), screenY);
                if(randRight > 0.15) ctx.fillText(sceneryEmojis[Math.floor((randRight * 100) % sceneryEmojis.length)], centerX + roadWidth/2 + 40 + (randRight*50), screenY);
            }

            for(let id in otherPlayers) {
                if(id !== playerId) {
                    let p = otherPlayers[id];
                    let screenY = (canvas.height - 300) + ((progress - p.progress) * 2500); 
                    if(screenY > -50 && screenY < canvas.height + 50) {
                        let trackAbsoluteY = myTrackAbsoluteY + (canvas.height - screenY);
                        let screenX = (canvas.width / 2) + getCurve(trackAbsoluteY) + (p.x * moveRange);
                        drawCar(ctx, screenX, screenY, p.color, p.name, getRoadAngle(trackAbsoluteY), false);
                    }
                }
            }

            let myScreenX = (canvas.width / 2) + getCurve(myCarAbsY) + (carX * moveRange);
            drawCar(ctx, myScreenX, canvas.height - 300, myColor, hasFinished ? "DONE" : "YOU", getRoadAngle(myCarAbsY) + ((steerDir * 0.3) * (speed / maxSpeed)), boostTimer > 0);

            drawMinimap();
            requestAnimationFrame(gameLoop);
        }

        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
    </script>
</body>
</html>